# https://taskfile.dev
version: "3"

tasks:
  compile-grammar:
    desc: Compile ANTLR grammar
    cmds:
      - uvx --from antlr4-tools antlr4 -Dlanguage=Go -o parser bpftrace.g4

  test:
    desc: Run Go tests
    cmds:
      - go test ./...

  test-tools:
    desc: Run tests against bpftrace/tools
    cmds:
      - go test ./...

  build:
    desc: Build the btfmt binary
    cmds:
      - go build ./cmd/btfmt

  fmt:
    desc: Format Go code
    cmds:
      - go fmt ./...

  lsp-smoke:
    desc: Smoke test for btfmt LSP (stdio)
    deps:
      - build
    cmds:
      - python3 scripts/lsp_smoke.py

  vscode-install:
    desc: Install dependencies for the VS Code extension
    dir: vscode-extension
    cmds:
      - npm install

  vscode-build:
    desc: Build the VS Code extension
    dir: vscode-extension
    deps:
      - vscode-install
    cmds:
      - npm run compile

  vscode-package:
    desc: Package the VS Code extension (vsix)
    dir: vscode-extension
    deps:
      - vscode-build
    cmds:
      - npx vsce package

  vscode-publish:
    desc: Publish the VS Code extension (requires VSCE_PAT)
    dir: vscode-extension
    deps:
      - vscode-build
    cmds:
      - npx vsce publish
